{% extends "base.html" %}

{% block title %}Voice Authentication - Voice Biometric Authentication{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <div class="text-center mb-4">
                        <i class="fas fa-shield-alt fa-3x text-primary mb-3"></i>
                        <h3 class="card-title">Voice Authentication</h3>
                        <p class="text-muted">Verify your identity using your voice</p>
                    </div>

                    <!-- Instructions -->
                    <div class="alert alert-info border-0 mb-4" role="alert">
                        <h6 class="alert-heading">
                            <i class="fas fa-info-circle me-2"></i>Authentication Steps
                        </h6>
                        <ol class="mb-0">
                            <li>Click the microphone button below</li>
                            <li>Speak clearly for 2-5 seconds</li>
                            <li>Wait for verification result</li>
                        </ol>
                    </div>

                    <!-- Recording Interface -->
                    <div class="text-center mb-4">
                        <div class="mb-3">
                            <div id="recording-indicator" class="d-inline-block position-relative">
                                <button id="record-btn" class="btn btn-primary btn-lg rounded-circle" style="width: 120px; height: 120px;">
                                    <i id="record-icon" class="fas fa-microphone fa-3x"></i>
                                </button>
                                <div id="recording-animation" class="position-absolute top-0 start-0 w-100 h-100 rounded-circle border border-danger" style="display: none; animation: pulse 1s infinite;"></div>
                            </div>
                        </div>
                        
                        <div id="recording-status" class="mb-3">
                            <span class="text-muted">Click the microphone to authenticate</span>
                        </div>

                        <!-- Audio Visualization -->
                        <div class="mb-3">
                            <canvas id="audio-visualizer" width="400" height="100" class="border rounded" style="display: none;"></canvas>
                        </div>
                    </div>

                    <!-- Authentication Result -->
                    <div id="auth-result" style="display: none;">
                        <!-- Results will be shown here -->
                    </div>

                    <!-- Action Buttons -->
                    <div class="text-center">
                        <button id="try-again-btn" class="btn btn-outline-primary me-2" style="display: none;">
                            <i class="fas fa-redo me-2"></i>Try Again
                        </button>
                        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                        </a>
                    </div>
                </div>
            </div>

            <!-- Tips Card -->
            <div class="card mt-4 border-0 bg-dark">
                <div class="card-body">
                    <h6 class="card-title">
                        <i class="fas fa-lightbulb me-2"></i>Tips for Better Authentication
                    </h6>
                    <ul class="text-muted mb-0 small">
                        <li>Speak in a quiet environment</li>
                        <li>Use your natural speaking voice</li>
                        <li>Speak at normal volume and pace</li>
                        <li>Try to match your enrollment conditions</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/audio_recorder.js') }}"></script>
<script>
// Initialize voice authentication
document.addEventListener('DOMContentLoaded', function() {
    const recorder = new AudioRecorder();
    
    const recordBtn = document.getElementById('record-btn');
    const recordIcon = document.getElementById('record-icon');
    const recordingStatus = document.getElementById('recording-status');
    const recordingAnimation = document.getElementById('recording-animation');
    const authResult = document.getElementById('auth-result');
    const tryAgainBtn = document.getElementById('try-again-btn');
    
    recordBtn.addEventListener('click', async function() {
        if (!recorder.isRecording) {
            try {
                await recorder.startRecording();
                recordIcon.className = 'fas fa-stop fa-3x';
                recordBtn.className = 'btn btn-danger btn-lg rounded-circle';
                recordingStatus.innerHTML = '<span class="text-danger fw-bold">Recording... Click to stop</span>';
                recordingAnimation.style.display = 'block';
                authResult.style.display = 'none';
            } catch (error) {
                showError('Error starting recording: ' + error.message);
            }
        } else {
            const audioBlob = await recorder.stopRecording();
            recordIcon.className = 'fas fa-microphone fa-3x';
            recordBtn.className = 'btn btn-primary btn-lg rounded-circle';
            recordingStatus.innerHTML = '<span class="text-muted">Processing authentication...</span>';
            recordingAnimation.style.display = 'none';
            recordBtn.disabled = true;
            
            // Authenticate the voice
            authenticateVoice(audioBlob);
        }
    });
    
    tryAgainBtn.addEventListener('click', function() {
        resetInterface();
    });
    
    async function authenticateVoice(audioBlob) {
        const formData = new FormData();
        formData.append('audio', audioBlob, 'auth_sample.wav');
        
        try {
            const response = await fetch('/authenticate_voice', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                showAuthResult(result);
            } else {
                showError(result.error || 'Authentication failed');
            }
        } catch (error) {
            showError('Authentication failed: ' + error.message);
        }
    }
    
    function showAuthResult(result) {
        recordBtn.disabled = false;
        recordingStatus.style.display = 'none';
        
        const confidence = Math.round(result.confidence * 100);
        
        if (result.authenticated) {
            authResult.innerHTML = `
                <div class="alert alert-success border-0 text-center">
                    <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                    <h5 class="alert-heading">Authentication Successful!</h5>
                    <p class="mb-2">${result.message}</p>
                    <hr>
                    <p class="mb-0">
                        <strong>Confidence Score:</strong> ${confidence}%
                        <div class="progress mt-2" style="height: 8px;">
                            <div class="progress-bar bg-success" style="width: ${confidence}%"></div>
                        </div>
                    </p>
                    <div class="mt-3">
                        <a href="{{ url_for('dashboard') }}" class="btn btn-success">
                            <i class="fas fa-tachometer-alt me-2"></i>Continue to Dashboard
                        </a>
                    </div>
                </div>
            `;
        } else {
            authResult.innerHTML = `
                <div class="alert alert-danger border-0 text-center">
                    <i class="fas fa-times-circle fa-3x text-danger mb-3"></i>
                    <h5 class="alert-heading">Authentication Failed</h5>
                    <p class="mb-2">${result.message}</p>
                    <hr>
                    <p class="mb-0">
                        <strong>Confidence Score:</strong> ${confidence}%
                        <div class="progress mt-2" style="height: 8px;">
                            <div class="progress-bar bg-danger" style="width: ${confidence}%"></div>
                        </div>
                    </p>
                </div>
            `;
            tryAgainBtn.style.display = 'inline-block';
        }
        
        authResult.style.display = 'block';
    }
    
    function showError(message) {
        recordBtn.disabled = false;
        recordingStatus.innerHTML = `<span class="text-danger">Error: ${message}</span>`;
        tryAgainBtn.style.display = 'inline-block';
    }
    
    function resetInterface() {
        recordBtn.disabled = false;
        recordingStatus.innerHTML = '<span class="text-muted">Click the microphone to authenticate</span>';
        recordingStatus.style.display = 'block';
        authResult.style.display = 'none';
        tryAgainBtn.style.display = 'none';
        recordIcon.className = 'fas fa-microphone fa-3x';
        recordBtn.className = 'btn btn-primary btn-lg rounded-circle';
    }
});
</script>

<style>
@keyframes pulse {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.1); opacity: 0.7; }
    100% { transform: scale(1); opacity: 1; }
}
</style>
{% endblock %}
